<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <title>주변 병원 확인하기</title>
  <style>
    /* 기존 스타일 유지 */
    #container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #map {
      flex: 2;
      height: 100%;
    }
    #list {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
      border-left: 1px solid #ccc;
    }
    .hospital-item {
      margin-bottom: 1em;
      padding: 0.5em;
      border-bottom: 1px solid #eee;
    }
    .hospital-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .hospital-header:hover {
      background-color: #f0f8ff;
    }
    .favorite-icon {
      font-size: 1.5em;
      color: gold;
      cursor: pointer;
      margin-left: 10px;
    }
    .tag-container {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag-pill {
      background-color: #e6f0ff;
      color: #0057a3;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 500;
      border: 1px solid #b0d0ff;
      display: inline-block;
    }
    .tag-pill.empty {
      background-color: #f5f5f5;
      color: #aaa;
      border-style: dashed;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="button-group">
  <button onclick="location.href='/join'">회원가입</button>
  <button onclick="location.href='/login'">로그인</button>
  <button onclick="location.href='/favList'">즐겨찾기 확인</button>
  <button onclick="location.href='/kakao'">카카오 로그인</button>
  <button onclick="location.href='/naver'">네이버 로그인</button>
</div>

<div id="container">
  <div id="map"></div>
  <div id="list"></div>
</div>

<!-- 모달 -->
<div id="hospitalModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>
<script th:inline="javascript">
  const JS_KEY = /*[[${javascriptKey}]]*/ "";
</script>

<script>
  // Kakao SDK 동적 로드
  function loadKakaoSDK(appkey, callback) {
    const script = document.createElement("script");
    script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${appkey}&autoload=false`;
    script.onload = callback;
    document.head.appendChild(script);
  }

  let map;
  let modalFavoriteIcon = null;

  async function loadData() {
    try {
      const response = await fetch("/api/loc/curr");
      return await response.json();
    } catch (error) {
      console.error("API 오류:", error);
      return null;
    }
  }

  async function initMap() {
    const curr = await loadData();
    if (!curr) {
      alert("현재 위치 정보를 불러올 수 없습니다.");
      return;
    }
    const currLat = Number(curr.lat);
    const currLong = Number(curr.long);


    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(currLat, currLong),
      level: 3
    };

    map = new kakao.maps.Map(mapContainer, mapOption);

    const currImageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png";
    const currImageSize = new kakao.maps.Size(24, 35);
    const currMarkerImage = new kakao.maps.MarkerImage(currImageSrc, currImageSize);

    const currPosition = new kakao.maps.LatLng(currLat, currLong);
    const currMarker = new kakao.maps.Marker({
      position: currPosition,
      image: currMarkerImage,
      map: map,
      title: "현재 위치"
    });

    await loadNear();
  }

  async function loadNear() {
    try {
      const response = await fetch("/api/loc");
      const hospitals = await response.json();
      makeMarker(hospitals);
    } catch (error) {
      console.error("API 오류:", error);
    }
  }

  function makeMarker(list) {
    const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    const listContainer = document.getElementById("list");
    listContainer.innerHTML = "";

    list.forEach(pos => {
      pos.favorite = pos.favorite || false;

      const latlng = new kakao.maps.LatLng(Number(pos.y), Number(pos.x));
      const imageSize = new kakao.maps.Size(24, 35);
      const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

      const marker = new kakao.maps.Marker({
        map: map,
        position: latlng,
        title: pos.place_name,
        image: markerImage
      });

      const item = document.createElement("div");
      item.className = "hospital-item";

      const header = document.createElement("div");
      header.className = "hospital-header";

      const info = document.createElement("div");

      const tagHTML = [pos.tag, pos.tag2, pos.tag3]
      .filter(Boolean)
      .map(tag => `<span class="tag-pill">${tag}</span>`)
      .join(" ");

      info.innerHTML = `
        <strong>${pos.place_name}</strong><br/>
        ${pos.road_address_name || pos.address_name}
        <div class="tag-container">${tagHTML || '<span class="tag-pill empty">태그 없음</span>'}</div>
      `;

      const favIcon = document.createElement("span");
      favIcon.className = "favorite-icon";
      favIcon.textContent = pos.favorite ? "⭐" : "☆";
      favIcon.dataset.id = pos.id;

      favIcon.addEventListener("click", async (e) => {
        e.stopPropagation();
        await toggleFavorite(pos, favIcon);
        updateOtherIcons(pos.id, pos.favorite);
      });

      header.appendChild(info);
      header.appendChild(favIcon);
      item.appendChild(header);
      listContainer.appendChild(item);

      header.addEventListener("click", () => {
        map.panTo(latlng);
        showModal(pos, favIcon);
      });

      kakao.maps.event.addListener(marker, "click", () => {
        showModal(pos, favIcon);
      });
    });
  }

  function updateOtherIcons(hospitalId, favoriteStatus) {
    document.querySelectorAll(".hospital-item .favorite-icon").forEach(icon => {
      if (icon.dataset.id === String(hospitalId)) {
        icon.textContent = favoriteStatus ? "⭐" : "☆";
      }
    });
    if (modalFavoriteIcon) {
      modalFavoriteIcon.textContent = favoriteStatus ? "⭐" : "☆";
    }
  }

  async function toggleFavorite(hospital, icon) {
    try {
      const res = await fetch("/api/favorite/" + hospital.id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(hospital)
      });
      if (!res.ok) throw new Error(await res.text());

      hospital.favorite = !hospital.favorite;
      icon.textContent = hospital.favorite ? "⭐" : "☆";
    } catch (error) {
      alert("즐겨찾기 실패: " + error.message);
    }
  }

  function showModal(hospital, originalIcon) {
    const modal = document.getElementById("hospitalModal");
    const modalBody = document.getElementById("modalBody");

    modalBody.innerHTML = `
      <h2>${hospital.place_name}</h2>
      <p><strong>주소:</strong> ${hospital.road_address_name || hospital.address_name}</p>
      <p><strong>전화:</strong> ${hospital.phone || "정보 없음"}</p>
      <p><strong>홈페이지:</strong> <a href="${hospital.place_url}" target="_blank">바로가기</a></p>
      <p><strong>태그:</strong> ${[hospital.tag, hospital.tag2, hospital.tag3].filter(Boolean).join(", ") || "없음"}</p>
    `;

    modalFavoriteIcon = document.createElement("span");
    modalFavoriteIcon.className = "favorite-icon";
    modalFavoriteIcon.textContent = hospital.favorite ? "⭐" : "☆";

    modalFavoriteIcon.addEventListener("click", async () => {
      await toggleFavorite(hospital, modalFavoriteIcon);
      updateOtherIcons(hospital.id, hospital.favorite);
    });

    modalBody.appendChild(modalFavoriteIcon);
    modal.style.display = "block";
  }

  function closeModal() {
    document.getElementById("hospitalModal").style.display = "none";
  }

  window.onclick = function(event) {
    const modal = document.getElementById("hospitalModal");
    if (event.target === modal) closeModal();
  };

  // Kakao SDK 로드 후 지도 초기화
  window.onload = () => {
    if (!JS_KEY || JS_KEY.trim() === "") {
      alert("JS_KEY가 설정되어 있지 않습니다.");
      return;
    }
    loadKakaoSDK(JS_KEY, () => {
      kakao.maps.load(() => {
        initMap();
      });
    });
  };
</script>
</body>
</html>
